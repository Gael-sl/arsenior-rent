<app-navbar></app-navbar>

<main class="min-h-screen bg-gradient-to-br from-stone-50 to-stone-100 section-padding transition-colors duration-300">
  <div class="container-custom">
    <div class="max-w-4xl mx-auto">
      
      <!-- Header -->
      <div class="text-center mb-8 relative">
        <button 
          (click)="goBack()" 
          class="absolute left-0 top-0 p-2 hover:bg-white/50 rounded-lg transition-colors"
          title="Volver">
          <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
            <line x1="19" y1="12" x2="5" y2="12"/>
            <polyline points="12 19 5 12 12 5"/>
          </svg>
        </button>
        <h1 class="font-playfair text-4xl mb-3">Mi Perfil</h1>
        <div class="divider mx-auto" style="max-width: 100px;"></div>
      </div>

      <div *ngIf="loading()">
        <app-loading-spinner [size]="200" message="Cargando perfil..."></app-loading-spinner>
      </div>

      <div *ngIf="error()" class="error-message mb-6">{{ error() }}</div>

      <div *ngIf="!loading() && user()">
        
        <!-- User Info Card -->
        <div class="bg-white/90 backdrop-blur-lg rounded-lg shadow-xl p-8 mb-8 border border-stone-200 transition-colors duration-300">
          <div class="flex items-start justify-between mb-6">
            <div class="flex items-center gap-4">
              <div class="w-20 h-20 bg-stone-900 text-white rounded-full flex items-center justify-center text-3xl font-playfair">
                {{ user()!.firstName.charAt(0) }}{{ user()!.lastName.charAt(0) }}
              </div>
              <div>
                <h2 class="font-playfair text-2xl">{{ user()!.firstName }} {{ user()!.lastName }}</h2>
                <p class="text-stone-600">{{ user()!.email }}</p>
              </div>
            </div>
            <button 
              (click)="toggleEditMode()" 
              class="btn-secondary"
              [class.btn-primary]="editMode()"
            >
              <span *ngIf="!editMode()">Editar Perfil</span>
              <span *ngIf="editMode()">Cancelar</span>
            </button>
          </div>

          <!-- Edit Mode Form -->
          <div *ngIf="editMode()" class="space-y-4 pt-6 border-t border-stone-200">
            <div class="grid grid-cols-2 gap-4">
              <div>
                <label class="dark:text-stone-300">Nombre</label>
                <input type="text" [(ngModel)]="formData.firstName" placeholder="Nombre" />
              </div>
              <div>
                <label class="dark:text-stone-300">Apellido</label>
                <input type="text" [(ngModel)]="formData.lastName" placeholder="Apellido" />
              </div>
            </div>
            <div>
              <label class="dark:text-stone-300">Teléfono</label>
              <input type="tel" [(ngModel)]="formData.phone" placeholder="Teléfono" />
            </div>
            <button (click)="saveProfile()" class="btn-primary w-full">
              Guardar Cambios
            </button>
          </div>

          <!-- View Mode Info -->
          <div *ngIf="!editMode()" class="grid grid-cols-3 gap-6 pt-6 border-t border-stone-200">
            <div class="text-center">
              <div class="text-3xl font-playfair font-bold text-stone-900">
                {{ user()!.rating ? user()!.rating.toFixed(1) : '0.0' }}
              </div>
              <p class="text-sm text-stone-600 mt-1">Calificación</p>
              <div class="flex justify-center gap-1 mt-2">
                <span 
                  *ngFor="let star of getStars(5)"
                  class="text-lg"
                  [class.text-black]="star <= Math.round(user()!.rating || 0)"
                  [class.dark:text-white]="star <= Math.round(user()!.rating || 0)"
                  [class.text-stone-300]="star > Math.round(user()!.rating || 0)"
                  [class.dark:text-stone-600]="star > Math.round(user()!.rating || 0)"
                >
                  ★
                </span>
              </div>
            </div>
            <div class="text-center">
              <div class="text-3xl font-playfair font-bold text-stone-900">
                {{ user()!.totalRentals || 0 }}
              </div>
              <p class="text-sm text-stone-600 mt-1">Rentas Totales</p>
            </div>
            <div class="text-center">
              <div class="text-3xl font-playfair font-bold text-stone-900">
                {{ favorites().length }}
              </div>
              <p class="text-sm text-stone-600 mt-1">Favoritos</p>
            </div>
          </div>
        </div>

        <!-- Tabs Navigation -->
        <div class="flex space-x-4 mb-6">
          <button
            (click)="setActiveTab('favorites')"
            class="px-6 py-3 rounded-lg font-medium transition-all"
            [class.bg-black]="activeTab() === 'favorites'"
            [class.text-white]="activeTab() === 'favorites'"
            [class.dark:bg-white]="activeTab() === 'favorites'"
            [class.dark:text-black]="activeTab() === 'favorites'"
            [class.bg-white]="activeTab() !== 'favorites'"
            [class.dark:bg-stone-800]="activeTab() !== 'favorites'"
            [class.text-stone-600]="activeTab() !== 'favorites'"
            [class.dark:text-stone-400]="activeTab() !== 'favorites'"
          >
            Mis Favoritos ({{ favorites().length }})
          </button>
          <button
            (click)="setActiveTab('ratings')"
            class="px-6 py-3 rounded-lg font-medium transition-all"
            [class.bg-black]="activeTab() === 'ratings'"
            [class.text-white]="activeTab() === 'ratings'"
            [class.dark:bg-white]="activeTab() === 'ratings'"
            [class.dark:text-black]="activeTab() === 'ratings'"
            [class.bg-white]="activeTab() !== 'ratings'"
            [class.dark:bg-stone-800]="activeTab() !== 'ratings'"
            [class.text-stone-600]="activeTab() !== 'ratings'"
            [class.dark:text-stone-400]="activeTab() !== 'ratings'"
          >
            Calificaciones ({{ ratings().length }})
          </button>
        </div>

        <!-- Favorites Section -->
        <div *ngIf="activeTab() === 'favorites'" class="bg-white/90 backdrop-blur-lg rounded-lg shadow-xl p-8 border border-stone-200 transition-colors duration-300">
          <h3 class="font-playfair text-2xl mb-6">Mis Favoritos</h3>

          <div *ngIf="favorites().length === 0" class="text-center py-12">
            <svg class="w-16 h-16 mx-auto text-stone-300 mb-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" 
                    d="M21 8.25c0-2.485-2.099-4.5-4.688-4.5-1.935 0-3.597 1.126-4.312 2.733-.715-1.607-2.377-2.733-4.313-2.733C5.1 3.75 3 5.765 3 8.25c0 7.22 9 12 9 12s9-4.78 9-12Z"/>
            </svg>
            <p class="text-stone-600 font-playfair text-lg">No tienes favoritos aún</p>
            <p class="text-sm text-stone-500 mt-2">Explora el catálogo y guarda los vehículos que te gusten</p>
            <a routerLink="/" class="btn-primary inline-block mt-4">Ver Catálogo</a>
          </div>

          <div *ngIf="favorites().length > 0" class="grid md:grid-cols-2 gap-6">
            <div 
              *ngFor="let car of favorites()"
              class="border border-stone-200 rounded-lg overflow-hidden hover:shadow-lg transition-shadow bg-white"
            >
              <div class="relative aspect-video">
                <img 
                  [src]="car.image" 
                  [alt]="car.brand + ' ' + car.model"
                  class="w-full h-full object-cover"
                />
                <button
                  (click)="removeFavorite(car.id)"
                  class="absolute top-3 right-3 w-8 h-8 rounded-full bg-white/90 flex items-center justify-center hover:scale-110 transition-all"
                >
                  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor" class="w-5 h-5 text-red-500">
                    <path d="m11.645 20.91-.007-.003-.022-.012a15.247 15.247 0 0 1-.383-.218 25.18 25.18 0 0 1-4.244-3.17C4.688 15.36 2.25 12.174 2.25 8.25 2.25 5.322 4.714 3 7.688 3A5.5 5.5 0 0 1 12 5.052 5.5 5.5 0 0 1 16.313 3c2.973 0 5.437 2.322 5.437 5.25 0 3.925-2.438 7.111-4.739 9.256a25.175 25.175 0 0 1-4.244 3.17 15.247 15.247 0 0 1-.383.219l-.022.012-.007.004-.003.001a.752.752 0 0 1-.704 0l-.003-.001Z" />
                  </svg>
                </button>
              </div>
              <div class="p-4">
                <h4 class="font-playfair text-lg mb-1">{{ car.brand }} {{ car.model }}</h4>
                <p class="text-sm text-stone-600 mb-3">{{ car.year }} • {{ car.transmission }}</p>
                <div class="flex items-center justify-between">
                  <span class="text-lg font-bold text-stone-900">${{ car.pricePerDay }} MXN/día</span>
                  <a 
                    [routerLink]="['/car', car.id]"
                    class="px-4 py-2 bg-black text-white rounded-lg text-sm font-medium hover:opacity-90 transition-opacity"
                  >
                    Ver Detalles
                  </a>
                </div>
              </div>
            </div>
          </div>
        </div>

        <!-- Ratings Received -->
        <div *ngIf="activeTab() === 'ratings'" class="bg-white/90 backdrop-blur-lg rounded-lg shadow-xl p-8 border border-stone-200 transition-colors duration-300">
          <h3 class="font-playfair text-2xl mb-6">Calificaciones Recibidas</h3>

          <div *ngIf="ratings().length === 0" class="text-center py-12">
            <svg class="w-16 h-16 mx-auto text-stone-300 mb-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" 
                    d="M11.049 2.927c.3-.921 1.603-.921 1.902 0l1.519 4.674a1 1 0 00.95.69h4.915c.969 0 1.371 1.24.588 1.81l-3.976 2.888a1 1 0 00-.363 1.118l1.518 4.674c.3.922-.755 1.688-1.538 1.118l-3.976-2.888a1 1 0 00-1.176 0l-3.976 2.888c-.783.57-1.838-.197-1.538-1.118l1.518-4.674a1 1 0 00-.363-1.118l-3.976-2.888c-.784-.57-.38-1.81.588-1.81h4.914a1 1 0 00.951-.69l1.519-4.674z"/>
            </svg>
            <p class="text-stone-600 font-playfair text-lg">Sin calificaciones aún</p>
            <p class="text-sm text-stone-500 mt-2">Completa más rentas para recibir calificaciones</p>
          </div>

          <div *ngIf="ratings().length > 0" class="space-y-4">
            <div 
              *ngFor="let rating of ratings()"
              class="border border-stone-200 rounded-lg p-6 hover:shadow-md transition-shadow"
            >
              <div class="flex justify-between items-start mb-4">
                <div>
                  <h4 class="font-semibold text-lg">{{ rating.car?.brand }} {{ rating.car?.model }}</h4>
                  <p class="text-sm text-stone-600">{{ formatDate(rating.createdAt) }}</p>
                </div>
                <div class="text-right">
                  <div class="text-2xl font-playfair font-bold">
                    {{ rating.adminToUserRating?.overallRating?.toFixed(1) }}
                  </div>
                  <div class="flex gap-1 mt-1">
                    <span 
                      *ngFor="let star of getStars(5)"
                      class="text-sm"
                      [class.text-black]="star <= Math.round(rating.adminToUserRating?.overallRating || 0)"
                      [class.dark:text-white]="star <= Math.round(rating.adminToUserRating?.overallRating || 0)"
                      [class.text-stone-300]="star > Math.round(rating.adminToUserRating?.overallRating || 0)"
                      [class.dark:text-stone-600]="star > Math.round(rating.adminToUserRating?.overallRating || 0)"
                    >
                      ★
                    </span>
                  </div>
                </div>
              </div>

              <div class="grid grid-cols-4 gap-4 mb-4 text-center text-sm">
                <div>
                  <p class="text-stone-600">Condición</p>
                  <p class="font-semibold">{{ rating.adminToUserRating?.vehicleReturnCondition }}/5</p>
                </div>
                <div>
                  <p class="text-stone-600">Puntualidad</p>
                  <p class="font-semibold">{{ rating.adminToUserRating?.punctuality }}/5</p>
                </div>
                <div>
                  <p class="text-stone-600">Comunicación</p>
                  <p class="font-semibold">{{ rating.adminToUserRating?.communication }}/5</p>
                </div>
                <div>
                  <p class="text-stone-600">Uso Responsable</p>
                  <p class="font-semibold">{{ rating.adminToUserRating?.responsibleUse }}/5</p>
                </div>
              </div>

              <div *ngIf="rating.adminToUserRating?.comments" 
                   class="bg-stone-50 rounded-lg p-4 text-sm text-stone-700 italic border-l-4 border-stone-900">
                "{{ rating.adminToUserRating?.comments }}"
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>
</main>

<app-footer></app-footer>
