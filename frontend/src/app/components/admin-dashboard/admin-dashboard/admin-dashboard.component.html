<app-navbar></app-navbar>

<main class="min-h-screen bg-gradient-to-br from-stone-50 to-stone-100">
  
  <!-- Header -->
  <section class="bg-white border-b border-stone-200 py-6">
    <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
      <div class="flex items-center justify-between">
        <h1 class="font-serif text-2xl text-stone-900">Panel de Administración</h1>
        <span class="inline-flex items-center px-3 py-1 rounded-full text-xs font-medium bg-emerald-50 text-emerald-700">
          <span class="w-2 h-2 bg-emerald-500 rounded-full mr-2 animate-pulse"></span>
          Sistema Activo
        </span>
      </div>
    </div>
  </section>

  <!-- Navigation Tabs -->
  <section class="bg-white/80 backdrop-blur-lg border-b border-stone-200/50 sticky top-0 z-40">
    <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
      <nav class="flex gap-1 overflow-x-auto py-2">
        <a routerLink="/admin" routerLinkActive="bg-black text-white" [routerLinkActiveOptions]="{exact: true}"
           class="px-4 py-2 text-sm font-medium text-stone-700 rounded-lg hover:bg-stone-100 transition-all whitespace-nowrap">
          Dashboard
        </a>
        <a routerLink="/admin/inventory" routerLinkActive="bg-black text-white"
           class="px-4 py-2 text-sm font-medium text-stone-700 rounded-lg hover:bg-stone-100 transition-all whitespace-nowrap">
          Inventario
        </a>
        <a routerLink="/admin/reservations" routerLinkActive="bg-black text-white"
           class="px-4 py-2 text-sm font-medium text-stone-700 rounded-lg hover:bg-stone-100 transition-all whitespace-nowrap">
          Reservas
        </a>
        <a routerLink="/admin/tracking" routerLinkActive="bg-black text-white"
           class="px-4 py-2 text-sm font-medium text-stone-700 rounded-lg hover:bg-stone-100 transition-all whitespace-nowrap">
          Tracking GPS
        </a>
        <a routerLink="/admin/maintenance" routerLinkActive="bg-black text-white"
           class="px-4 py-2 text-sm font-medium text-stone-700 rounded-lg hover:bg-stone-100 transition-all whitespace-nowrap">
          Mantenimiento
        </a>    
      </nav>
    </div>
  </section>

  <!-- Main Content -->
  <section class="py-8">
    <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
      
      @if (loading()) {
        <div class="flex items-center justify-center py-20">
          <app-loading-spinner [size]="300" message="Cargando estadísticas..."></app-loading-spinner>
        </div>
      }

      @if (error()) {
        <div class="bg-red-50 border-l-4 border-red-500 p-4 rounded-lg mb-6">
          <p class="text-sm text-red-700">{{ error() }}</p>
        </div>
      }

      @if (stats()) {
        <!-- KPIs Grid - Cards con Glassmorphism -->
        <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-6 mb-8">
          
          <!-- Total Revenue -->
          <div class="bg-white/70 backdrop-blur-lg border border-stone-200/50 rounded-2xl p-6 shadow-lg hover:shadow-xl transition-all">
            <div class="flex items-center justify-between mb-4">
              <div class="w-12 h-12 bg-black rounded-xl flex items-center justify-center">
                <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="white" stroke-width="2">
                  <line x1="12" y1="1" x2="12" y2="23"/>
                  <path d="M17 5H9.5a3.5 3.5 0 0 0 0 7h5a3.5 3.5 0 0 1 0 7H6"/>
                </svg>
              </div>
              <div class="px-2 py-1 rounded-full text-xs font-medium" 
                   [ngClass]="[getGrowthBgClass(stats()!.revenueGrowth), getGrowthClass(stats()!.revenueGrowth)]">
                {{ getGrowthIcon(stats()!.revenueGrowth) }} {{ Math.abs(stats()!.revenueGrowth).toFixed(1) }}%
              </div>
            </div>
            <p class="text-sm text-stone-500 mb-1">Ingresos Totales</p>
            <p class="text-2xl font-serif text-stone-900">{{ formatCurrency(stats()!.totalRevenue) }}</p>
            <p class="text-xs text-stone-400 mt-2">vs mes anterior</p>
          </div>

          <!-- Total Reservations -->
          <div class="bg-white/70 backdrop-blur-lg border border-stone-200/50 rounded-2xl p-6 shadow-lg hover:shadow-xl transition-all">
            <div class="flex items-center justify-between mb-4">
              <div class="w-12 h-12 bg-blue-600 rounded-xl flex items-center justify-center">
                <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="white" stroke-width="2">
                  <rect x="3" y="4" width="18" height="18" rx="2" ry="2"/>
                  <line x1="16" y1="2" x2="16" y2="6"/>
                  <line x1="8" y1="2" x2="8" y2="6"/>
                  <line x1="3" y1="10" x2="21" y2="10"/>
                </svg>
              </div>
              <span class="px-2 py-1 bg-blue-50 text-blue-600 rounded-full text-xs font-medium">Total</span>
            </div>
            <p class="text-sm text-stone-500 mb-1">Reservas Totales</p>
            <p class="text-2xl font-serif text-stone-900">{{ stats()!.totalReservations }}</p>
            <p class="text-xs text-stone-400 mt-2">Todas las reservas registradas</p>
          </div>

          <!-- Active Rentals -->
          <div class="bg-white/70 backdrop-blur-lg border border-stone-200/50 rounded-2xl p-6 shadow-lg hover:shadow-xl transition-all">
            <div class="flex items-center justify-between mb-4">
              <div class="w-12 h-12 bg-emerald-600 rounded-xl flex items-center justify-center">
                <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="white" stroke-width="2">
                  <circle cx="12" cy="12" r="10"/>
                  <polyline points="12 6 12 12 16 14"/>
                </svg>
              </div>
              <span class="px-2 py-1 bg-emerald-50 text-emerald-600 rounded-full text-xs font-medium animate-pulse">En curso</span>
            </div>
            <p class="text-sm text-stone-500 mb-1">Rentas Activas</p>
            <p class="text-2xl font-serif text-stone-900">{{ stats()!.activeRentals }}</p>
            <a routerLink="/admin/tracking" class="text-xs text-emerald-600 hover:underline mt-2 inline-block">
              Ver en mapa →
            </a>
          </div>

          <!-- Available Vehicles -->
          <div class="bg-white/70 backdrop-blur-lg border border-stone-200/50 rounded-2xl p-6 shadow-lg hover:shadow-xl transition-all">
            <div class="flex items-center justify-between mb-4">
              <div class="w-12 h-12 bg-amber-500 rounded-xl flex items-center justify-center">
                <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="white" stroke-width="2">
                  <path d="M14 16H9m10 0h3v-3.15a1 1 0 0 0-.84-.99L16 11l-2.7-3.6a1 1 0 0 0-.8-.4H5.24a2 2 0 0 0-1.8 1.1l-.8 1.63A6 6 0 0 0 2 12.42V16h2"/>
                  <circle cx="6.5" cy="16.5" r="2.5"/>
                  <circle cx="16.5" cy="16.5" r="2.5"/>
                </svg>
              </div>
              <span class="px-2 py-1 bg-amber-50 text-amber-600 rounded-full text-xs font-medium">
                {{ stats()!.vehiclesInMaintenance }} en mant.
              </span>
            </div>
            <p class="text-sm text-stone-500 mb-1">Vehículos Disponibles</p>
            <p class="text-2xl font-serif text-stone-900">{{ stats()!.availableVehicles }}</p>
            <a routerLink="/admin/inventory" class="text-xs text-amber-600 hover:underline mt-2 inline-block">
              Ver inventario →
            </a>
          </div>
        </div>

        <!-- Charts Row 1 -->
        <div class="grid grid-cols-1 lg:grid-cols-3 gap-6 mb-8">
          
          <!-- Revenue Chart (2 columns) -->
          <div class="lg:col-span-2 bg-white/70 backdrop-blur-lg border border-stone-200/50 rounded-2xl p-6 shadow-lg">
            <div class="flex items-center justify-between mb-6">
              <div>
                <h3 class="font-serif text-xl text-stone-900">Ingresos por Mes</h3>
                <p class="text-sm text-stone-500">Últimos 6 meses</p>
              </div>
              <div class="flex items-center space-x-2">
                <span class="w-3 h-3 bg-black rounded-full"></span>
                <span class="text-xs text-stone-600">Ingresos MXN</span>
              </div>
            </div>
            <div class="h-72">
              <canvas #revenueChart></canvas>
            </div>
          </div>

          <!-- Vehicle Status Chart -->
          <div class="bg-white/70 backdrop-blur-lg border border-stone-200/50 rounded-2xl p-6 shadow-lg">
            <div class="mb-6">
              <h3 class="font-serif text-xl text-stone-900">Estado de Flota</h3>
              <p class="text-sm text-stone-500">Distribución actual</p>
            </div>
            <div class="h-64">
              <canvas #occupancyChart></canvas>
            </div>
          </div>
        </div>

        <!-- Charts Row 2 -->
        <div class="grid grid-cols-1 lg:grid-cols-2 gap-6 mb-8">
          
          <!-- Reservations Chart -->
          <div class="bg-white/70 backdrop-blur-lg border border-stone-200/50 rounded-2xl p-6 shadow-lg">
            <div class="flex items-center justify-between mb-6">
              <div>
                <h3 class="font-serif text-xl text-stone-900">Reservas por Mes</h3>
                <p class="text-sm text-stone-500">Cantidad de reservas</p>
              </div>
            </div>
            <div class="h-64">
              <canvas #reservationsChart></canvas>
            </div>
          </div>

          <!-- Segment Distribution -->
          <div class="bg-white/70 backdrop-blur-lg border border-stone-200/50 rounded-2xl p-6 shadow-lg">
            <div class="mb-6">
              <h3 class="font-serif text-xl text-stone-900">Distribución por Segmento</h3>
              <p class="text-sm text-stone-500">Reservas por categoría</p>
            </div>
            <div class="h-64">
              <canvas #segmentChart></canvas>
            </div>
          </div>
        </div>

        <!-- Bottom Section - Lists -->
        <div class="grid grid-cols-1 lg:grid-cols-3 gap-6 mb-8">
          
          <!-- Top Rated Cars -->
          <div class="bg-white/70 backdrop-blur-lg border border-stone-200/50 rounded-2xl p-6 shadow-lg">
            <div class="flex items-center justify-between mb-6">
              <h3 class="font-serif text-lg text-stone-900">Top Vehiculos</h3>
              <a routerLink="/admin/inventory" class="text-xs text-stone-500 hover:text-black">Ver todos →</a>
            </div>
            <div class="space-y-4">
              @for (car of stats()!.topRatedCars.slice(0, 5); track car.id; let i = $index) {
                <div class="flex items-center space-x-3">
                  <div class="w-8 h-8 bg-stone-100 rounded-lg flex items-center justify-center text-sm font-bold text-stone-600">
                    {{ i + 1 }}
                  </div>
                  <div class="flex-1 min-w-0">
                    <p class="text-sm font-medium text-stone-900 truncate">{{ car.brand }} {{ car.model }}</p>
                    <p class="text-xs text-stone-500">{{ car.totalRatings }} reseñas</p>
                  </div>
                  <div class="flex items-center space-x-1 bg-amber-50 px-2 py-1 rounded-lg">
                    <span class="text-amber-500">★</span>
                    <span class="text-sm font-medium text-amber-700">{{ car.rating.toFixed(1) }}</span>
                  </div>
                </div>
              }
            </div>
          </div>

          <!-- Top Users -->
          <div class="bg-white/70 backdrop-blur-lg border border-stone-200/50 rounded-2xl p-6 shadow-lg">
            <div class="flex items-center justify-between mb-6">
              <h3 class="font-serif text-lg text-stone-900">Top Clientes</h3>
            </div>
            <div class="space-y-4">
              @for (user of stats()!.topRatedUsers.slice(0, 5); track user.id; let i = $index) {
                <div class="flex items-center space-x-3">
                  <div class="w-8 h-8 bg-gradient-to-br from-stone-800 to-stone-600 rounded-full flex items-center justify-center text-xs font-bold text-white">
                    {{ user.firstName.charAt(0) }}{{ user.lastName.charAt(0) }}
                  </div>
                  <div class="flex-1 min-w-0">
                    <p class="text-sm font-medium text-stone-900 truncate">{{ user.firstName }} {{ user.lastName }}</p>
                    <p class="text-xs text-stone-500">{{ user.totalRentals }} rentas</p>
                  </div>
                  <div class="flex items-center space-x-1 bg-emerald-50 px-2 py-1 rounded-lg">
                    <span class="text-emerald-500">★</span>
                    <span class="text-sm font-medium text-emerald-700">{{ user.rating.toFixed(1) }}</span>
                  </div>
                </div>
              }
              @empty {
                <p class="text-stone-500 text-sm text-center py-4">No hay clientes con rentas aún</p>
              }
            </div>
          </div>

          <!-- TODOS LOS USUARIOS -->
          <div class="bg-white/70 backdrop-blur-lg border border-stone-200/50 rounded-2xl p-6 shadow-lg lg:col-span-2">
            <div class="flex items-center justify-between mb-6">
              <h3 class="font-serif text-lg text-stone-900">Todos los Usuarios</h3>
              <span class="text-xs bg-stone-100 px-2 py-1 rounded-full text-stone-600">
                {{ stats()!.allUsers.length || 0 }} registrados
              </span>
            </div>
            <div class="overflow-x-auto">
              <table class="w-full text-sm">
                <thead>
                  <tr class="border-b border-stone-200">
                    <th class="text-left py-3 px-2 font-medium text-stone-600">Usuario</th>
                    <th class="text-left py-3 px-2 font-medium text-stone-600">Email</th>
                    <th class="text-center py-3 px-2 font-medium text-stone-600">Rol</th>
                    <th class="text-center py-3 px-2 font-medium text-stone-600">Verificado</th>
                    <th class="text-center py-3 px-2 font-medium text-stone-600">Rentas</th>
                  </tr>
                </thead>
                <tbody>
                  @for (user of stats()!.allUsers; track user.id) {
                    <tr class="border-b border-stone-100 hover:bg-stone-50">
                      <td class="py-3 px-2">
                        <div class="flex items-center space-x-2">
                          <div class="w-8 h-8 bg-gradient-to-br from-stone-700 to-stone-500 rounded-full flex items-center justify-center text-xs font-bold text-white">
                            {{ user.firstName.charAt(0) }}{{ user.lastName.charAt(0) }}
                          </div>
                          <span class="font-medium text-stone-900">{{ user.firstName }} {{ user.lastName }}</span>
                        </div>
                      </td>
                      <td class="py-3 px-2 text-stone-600">{{ user.email }}</td>
                      <td class="py-3 px-2 text-center">
                        <span [class]="user.role === 'admin' ? 'bg-purple-100 text-purple-700' : 'bg-blue-100 text-blue-700'" 
                              class="px-2 py-0.5 rounded-full text-xs font-medium">
                          {{ user.role === 'admin' ? 'Admin' : 'Usuario' }}
                        </span>
                      </td>
                      <td class="py-3 px-2 text-center">
                        @if (user.emailVerified) {
                          <span class="text-emerald-500">✓</span>
                        } @else {
                          <span class="text-red-500">✗</span>
                        }
                      </td>
                      <td class="py-3 px-2 text-center text-stone-600">{{ user.totalRentals || 0 }}</td>
                    </tr>
                  }
                  @empty {
                    <tr>
                      <td colspan="5" class="py-8 text-center text-stone-500">No hay usuarios registrados</td>
                    </tr>
                  }
                </tbody>
              </table>
            </div>
          </div>

          <!-- Quick Stats -->
          <div class="bg-white/70 backdrop-blur-lg border border-stone-200/50 rounded-2xl p-6 shadow-lg">
            <h3 class="font-serif text-lg text-stone-900 mb-6">Resumen Rapido</h3>
            <div class="space-y-4">
              <div class="flex items-center justify-between p-3 bg-stone-50 rounded-lg">
                <span class="text-sm text-stone-600">Total Usuarios</span>
                <span class="font-semibold text-stone-900">{{ stats()!.totalUsers }}</span>
              </div>
              <div class="flex items-center justify-between p-3 bg-stone-50 rounded-lg">
                <span class="text-sm text-stone-600">Rating Promedio</span>
                <div class="flex items-center space-x-1">
                  <span class="text-amber-500">★</span>
                  <span class="font-semibold text-stone-900">{{ stats()!.averageRating.toFixed(1) }}</span>
                </div>
              </div>
              <div class="flex items-center justify-between p-3 bg-emerald-50 rounded-lg">
                <span class="text-sm text-emerald-700">Ingresos Este Mes</span>
                <span class="font-semibold text-emerald-700">{{ formatCurrency(stats()!.revenueThisMonth) }}</span>
              </div>
              <div class="flex items-center justify-between p-3 bg-stone-50 rounded-lg">
                <span class="text-sm text-stone-600">Ingresos Mes Anterior</span>
                <span class="font-semibold text-stone-900">{{ formatCurrency(stats()!.revenueLastMonth) }}</span>
              </div>
            </div>
          </div>
        </div>

        <!-- Recent Reservations -->
        <div class="bg-white/70 backdrop-blur-lg border border-stone-200/50 rounded-2xl shadow-lg overflow-hidden">
          <div class="p-6 border-b border-stone-200/50">
            <div class="flex items-center justify-between">
              <div>
                <h3 class="font-serif text-xl text-stone-900">Reservas Recientes</h3>
                <p class="text-sm text-stone-500">Últimas 10 reservaciones</p>
              </div>
              <a routerLink="/admin/reservations" class="px-4 py-2 bg-black text-white text-sm rounded-lg hover:bg-stone-800 transition-colors">
                Ver todas
              </a>
            </div>
          </div>
          <div class="overflow-x-auto">
            <table class="w-full">
              <thead class="bg-stone-50">
                <tr>
                  <th class="px-6 py-3 text-left text-xs font-medium text-stone-500 uppercase tracking-wider">ID</th>
                  <th class="px-6 py-3 text-left text-xs font-medium text-stone-500 uppercase tracking-wider">Cliente</th>
                  <th class="px-6 py-3 text-left text-xs font-medium text-stone-500 uppercase tracking-wider">Vehículo</th>
                  <th class="px-6 py-3 text-left text-xs font-medium text-stone-500 uppercase tracking-wider">Fecha</th>
                  <th class="px-6 py-3 text-left text-xs font-medium text-stone-500 uppercase tracking-wider">Estado</th>
                  <th class="px-6 py-3 text-right text-xs font-medium text-stone-500 uppercase tracking-wider">Total</th>
                </tr>
              </thead>
              <tbody class="divide-y divide-stone-100">
                @for (reservation of stats()!.recentReservations.slice(0, 10); track reservation.id) {
                  <tr class="hover:bg-stone-50/50 transition-colors">
                    <td class="px-6 py-4 whitespace-nowrap">
                      <span class="text-sm font-mono text-stone-600">#{{ reservation.id }}</span>
                    </td>
                    <td class="px-6 py-4 whitespace-nowrap">
                      <div class="flex items-center space-x-3">
                        <div class="w-8 h-8 bg-stone-200 rounded-full flex items-center justify-center text-xs font-medium text-stone-600">
                          {{ reservation.user?.firstName?.charAt(0) }}{{ reservation.user?.lastName?.charAt(0) }}
                        </div>
                        <div>
                          <p class="text-sm font-medium text-stone-900">{{ reservation.user?.firstName }} {{ reservation.user?.lastName }}</p>
                        </div>
                      </div>
                    </td>
                    <td class="px-6 py-4 whitespace-nowrap">
                      <p class="text-sm text-stone-900">{{ reservation.car?.brand }} {{ reservation.car?.model }}</p>
                    </td>
                    <td class="px-6 py-4 whitespace-nowrap">
                      <p class="text-sm text-stone-600">{{ reservation.startDate }}</p>
                    </td>
                    <td class="px-6 py-4 whitespace-nowrap">
                      <span class="px-3 py-1 text-xs font-medium rounded-full" [ngClass]="getStatusColor(reservation.status)">
                        {{ reservation.status }}
                      </span>
                    </td>
                    <td class="px-6 py-4 whitespace-nowrap text-right">
                      <span class="text-sm font-semibold text-stone-900">{{ formatCurrency(reservation.totalAmount) }}</span>
                    </td>
                  </tr>
                }
              </tbody>
            </table>
          </div>
        </div>
      }
    </div>
  </section>
</main>

<div class="w-screen relative left-1/2 right-1/2 -mx-[50vw]">
  <app-footer></app-footer>
</div>
