<app-navbar></app-navbar>

<main class="min-h-screen bg-gradient-to-br from-stone-50 to-stone-100">
  
  <!-- Header -->
  <section class="bg-white border-b border-stone-200 py-6">
    <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
      <h1 class="font-serif text-2xl text-stone-900">Sistema de Mantenimiento</h1>
    </div>
  </section>

  <!-- Navigation Tabs -->
  <section class="bg-white/80 backdrop-blur-lg border-b border-stone-200/50 sticky top-0 z-40">
    <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
      <nav class="flex gap-1 overflow-x-auto py-2">
        <a routerLink="/admin" routerLinkActive="bg-black text-white" [routerLinkActiveOptions]="{exact: true}"
           class="px-4 py-2 text-sm font-medium text-stone-700 rounded-lg hover:bg-stone-100 transition-all whitespace-nowrap">
          Dashboard
        </a>
        <a routerLink="/admin/inventory" routerLinkActive="bg-black text-white"
           class="px-4 py-2 text-sm font-medium text-stone-700 rounded-lg hover:bg-stone-100 transition-all whitespace-nowrap">
          Inventario
        </a>
        <a routerLink="/admin/reservations" routerLinkActive="bg-black text-white"
           class="px-4 py-2 text-sm font-medium text-stone-700 rounded-lg hover:bg-stone-100 transition-all whitespace-nowrap">
          Reservas
        </a>
        <a routerLink="/admin/tracking" routerLinkActive="bg-black text-white"
           class="px-4 py-2 text-sm font-medium text-stone-700 rounded-lg hover:bg-stone-100 transition-all whitespace-nowrap">
          Tracking GPS
        </a>
        <a routerLink="/admin/maintenance" routerLinkActive="bg-black text-white"
           class="px-4 py-2 text-sm font-medium text-stone-700 rounded-lg hover:bg-stone-100 transition-all whitespace-nowrap">
          Mantenimiento
        </a>
      </nav>
    </div>
  </section>

  <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8">
    
    <!-- Page Title & Actions -->
    <div class="flex flex-col md:flex-row md:items-center md:justify-between gap-4 mb-8">
      <div>
        <h1 class="font-serif text-3xl text-stone-900 mb-2">Sistema de Mantenimiento</h1>
        <p class="text-stone-600">Gestiona el mantenimiento y reparaciones de la flota</p>
      </div>
      <button
        (click)="showAddMaintenanceModal = true"
        class="px-6 py-3 bg-black hover:bg-stone-800 text-white rounded-lg font-medium transition-all flex items-center space-x-2"
      >
        <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
          <line x1="12" y1="5" x2="12" y2="19"/>
          <line x1="5" y1="12" x2="19" y2="12"/>
        </svg>
        <span>Registrar Mantenimiento</span>
      </button>
    </div>

    <!-- Filter Tabs -->
    <div class="flex space-x-2 mb-8 overflow-x-auto">
      <button
        (click)="filterStatus = 'all'"
        [class.bg-black]="filterStatus === 'all'"
        [class.text-white]="filterStatus === 'all'"
        [class.bg-white]="filterStatus !== 'all'"
        [class.text-stone-700]="filterStatus !== 'all'"
        class="px-4 py-2 rounded-lg font-medium transition-all whitespace-nowrap"
      >
        Todos
      </button>
      <button
        (click)="filterStatus = 'en_proceso'"
        [class.bg-black]="filterStatus === 'en_proceso'"
        [class.text-white]="filterStatus === 'en_proceso'"
        [class.bg-white]="filterStatus !== 'en_proceso'"
        [class.text-stone-700]="filterStatus !== 'en_proceso'"
        class="px-4 py-2 rounded-lg font-medium transition-all whitespace-nowrap"
      >
        En Proceso
      </button>
      <button
        (click)="filterStatus = 'completado'"
        [class.bg-black]="filterStatus === 'completado'"
        [class.text-white]="filterStatus === 'completado'"
        [class.bg-white]="filterStatus !== 'completado'"
        [class.text-stone-700]="filterStatus !== 'completado'"
        class="px-4 py-2 rounded-lg font-medium transition-all whitespace-nowrap"
      >
        Completados
      </button>
      <button
        (click)="filterStatus = 'programado'"
        [class.bg-black]="filterStatus === 'programado'"
        [class.text-white]="filterStatus === 'programado'"
        [class.bg-white]="filterStatus !== 'programado'"
        [class.text-stone-700]="filterStatus !== 'programado'"
        class="px-4 py-2 rounded-lg font-medium transition-all whitespace-nowrap"
      >
        Programados
      </button>
    </div>

    <!-- Stats Cards -->
    <div class="grid md:grid-cols-4 gap-6 mb-8">
      <!-- Total Gastado -->
      <div class="bg-white/60 backdrop-blur-sm border border-stone-200/50 shadow-lg rounded-2xl p-6">
        <div class="flex items-center space-x-3 mb-3">
          <div class="w-10 h-10 bg-red-100 rounded-lg flex items-center justify-center">
            <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" class="text-red-600">
              <line x1="12" y1="1" x2="12" y2="23"/>
              <path d="M17 5H9.5a3.5 3.5 0 0 0 0 7h5a3.5 3.5 0 0 1 0 7H6"/>
            </svg>
          </div>
          <p class="text-sm text-stone-600">Total Gastado</p>
        </div>
        <p class="text-3xl font-serif text-stone-900">${{ getTotalCost() }}</p>
        <p class="text-xs text-stone-500 mt-2">Este mes</p>
      </div>

      <!-- En Proceso -->
      <div class="bg-white/60 backdrop-blur-sm border border-stone-200/50 shadow-lg rounded-2xl p-6">
        <div class="flex items-center space-x-3 mb-3">
          <div class="w-10 h-10 bg-amber-100 rounded-lg flex items-center justify-center">
            <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" class="text-amber-600">
              <circle cx="12" cy="12" r="10"/>
              <polyline points="12 6 12 12 16 14"/>
            </svg>
          </div>
          <p class="text-sm text-stone-600">En Proceso</p>
        </div>
        <p class="text-3xl font-serif text-stone-900">{{ getCountByStatus('en_proceso') }}</p>
        <p class="text-xs text-stone-500 mt-2">Vehículos</p>
      </div>

      <!-- Completados -->
      <div class="bg-white/60 backdrop-blur-sm border border-stone-200/50 shadow-lg rounded-2xl p-6">
        <div class="flex items-center space-x-3 mb-3">
          <div class="w-10 h-10 bg-emerald-100 rounded-lg flex items-center justify-center">
            <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" class="text-emerald-600">
              <path d="M22 11.08V12a10 10 0 1 1-5.93-9.14"/>
              <polyline points="22 4 12 14.01 9 11.01"/>
            </svg>
          </div>
          <p class="text-sm text-stone-600">Completados</p>
        </div>
        <p class="text-3xl font-serif text-stone-900">{{ getCountByStatus('completado') }}</p>
        <p class="text-xs text-stone-500 mt-2">Este mes</p>
      </div>

      <!-- Programados -->
      <div class="bg-white/60 backdrop-blur-sm border border-stone-200/50 shadow-lg rounded-2xl p-6">
        <div class="flex items-center space-x-3 mb-3">
          <div class="w-10 h-10 bg-blue-100 rounded-lg flex items-center justify-center">
            <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" class="text-blue-600">
              <rect x="3" y="4" width="18" height="18" rx="2" ry="2"/>
              <line x1="16" y1="2" x2="16" y2="6"/>
              <line x1="8" y1="2" x2="8" y2="6"/>
              <line x1="3" y1="10" x2="21" y2="10"/>
            </svg>
          </div>
          <p class="text-sm text-stone-600">Programados</p>
        </div>
        <p class="text-3xl font-serif text-stone-900">{{ getCountByStatus('programado') }}</p>
        <p class="text-xs text-stone-500 mt-2">Próximos</p>
      </div>
    </div>

    <!-- Maintenance List -->
    @if (loading()) {
      <div class="flex items-center justify-center py-20">
        <div class="loading-lg"></div>
      </div>
    }

    @if (error()) {
      <div class="bg-red-50 border-l-4 border-red-500 p-4 rounded mb-6">
        <p class="text-sm text-red-700">{{ error() }}</p>
      </div>
    }

    <div class="space-y-4">
      @for (maintenance of getFilteredMaintenances(); track maintenance.id) {
        <div class="bg-white/60 backdrop-blur-sm border border-stone-200/50 shadow-lg hover:shadow-xl transition-all rounded-2xl overflow-hidden">
          <div class="p-6">
            <!-- Header -->
            <div class="flex flex-col md:flex-row md:items-start md:justify-between gap-4 mb-4">
              <div class="flex-1">
                <div class="flex items-center space-x-3 mb-2">
                  <h3 class="text-xl font-serif text-stone-900">
                    {{ maintenance.car.brand }} {{ maintenance.car.model }}
                  </h3>
                  @if (maintenance.status === 'en_proceso') {
                    <span class="px-3 py-1 bg-amber-100 text-amber-700 border border-amber-200 rounded-full text-xs font-medium">
                      En Proceso
                    </span>
                  } @else if (maintenance.status === 'completado') {
                    <span class="px-3 py-1 bg-emerald-100 text-emerald-700 border border-emerald-200 rounded-full text-xs font-medium">
                      Completado
                    </span>
                  } @else {
                    <span class="px-3 py-1 bg-blue-100 text-blue-700 border border-blue-200 rounded-full text-xs font-medium">
                      Programado
                    </span>
                  }
                </div>
                <p class="text-sm text-stone-600">{{ maintenance.car.year }} • {{ maintenance.car.segment }}</p>
                <p class="text-sm text-stone-500 mt-1">Inicio: {{ maintenance.startDate }}</p>
              </div>

              <div class="text-left md:text-right">
                <p class="text-2xl font-serif text-stone-900">${{ maintenance.totalCost }}</p>
                <p class="text-xs text-stone-500">Costo Total</p>
                @if (maintenance.endDate) {
                  <p class="text-xs text-stone-500 mt-1">Fin: {{ maintenance.endDate }}</p>
                }
              </div>
            </div>

            <!-- Type -->
            <div class="mb-4">
              <p class="text-sm font-medium text-stone-700 mb-2">Tipo de Mantenimiento:</p>
              <div class="flex flex-wrap gap-2">
                @for (type of maintenance.types; track type) {
                  <span class="px-3 py-1 bg-stone-100 text-stone-700 rounded-lg text-xs">
                    {{ type }}
                  </span>
                }
              </div>
            </div>

            <!-- Items Breakdown -->
            <div class="mb-4">
              <button
                (click)="toggleDetails(maintenance.id)"
                class="flex items-center space-x-2 text-sm text-stone-700 hover:text-black transition-colors"
              >
                <svg [class.rotate-90]="expandedItems.has(maintenance.id)" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" class="transition-transform">
                  <polyline points="9 18 15 12 9 6"/>
                </svg>
                <span>{{ expandedItems.has(maintenance.id) ? 'Ocultar' : 'Ver' }} Desglose de Gastos ({{ maintenance.items.length }} items)</span>
              </button>

              @if (expandedItems.has(maintenance.id)) {
                <div class="mt-4 space-y-3 pl-6">
                  @for (item of maintenance.items; track item.id) {
                    <div class="flex items-center justify-between p-3 bg-stone-50 rounded-lg border border-stone-200">
                      <div class="flex items-center space-x-3">
                        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" class="text-stone-600">
                          <circle cx="12" cy="12" r="3"/>
                          <path d="M12 1v6m0 6v6"/>
                        </svg>
                        <div>
                          <p class="font-medium text-stone-900">{{ item.description }}</p>
                          <p class="text-xs text-stone-500">{{ item.category }}</p>
                        </div>
                      </div>
                      <p class="font-medium text-stone-900">${{ item.cost }}</p>
                    </div>
                  }
                </div>
              }
            </div>

            <!-- Notes -->
            @if (maintenance.notes) {
              <div class="mb-4 p-3 bg-stone-50 rounded-lg border border-stone-200">
                <p class="text-sm text-stone-700">{{ maintenance.notes }}</p>
              </div>
            }

            <!-- Mechanic -->
            <div class="flex items-center justify-between pt-4 border-t border-stone-200">
              <div class="flex items-center space-x-2">
                <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" class="text-stone-600">
                  <path d="M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2"/>
                  <circle cx="12" cy="7" r="4"/>
                </svg>
                <p class="text-sm text-stone-600">Mecánico: <span class="font-medium text-stone-900">{{ maintenance.mechanic }}</span></p>
              </div>

              <div class="flex items-center space-x-2">
                <button
                  (click)="editMaintenance(maintenance)"
                  class="p-2 hover:bg-stone-100 rounded-lg transition-colors"
                >
                  <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" class="text-stone-600">
                    <path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7"/>
                    <path d="M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z"/>
                  </svg>
                </button>
                @if (maintenance.status !== 'completado') {
                  <button
                    (click)="completeMaintenance(maintenance.id)"
                    class="px-4 py-2 bg-emerald-600 hover:bg-emerald-700 text-white text-sm rounded-lg transition-colors"
                  >
                    Marcar como Completado
                  </button>
                }
              </div>
            </div>
          </div>
        </div>
      }

      @if (getFilteredMaintenances().length === 0) {
        <div class="text-center py-16">
          <div class="w-16 h-16 bg-stone-200 rounded-full mx-auto mb-4 flex items-center justify-center">
            <svg class="text-stone-500" width="32" height="32" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round">
              <line x1="18" y1="6" x2="6" y2="18"/>
              <line x1="6" y1="6" x2="18" y2="18"/>
            </svg>
          </div>
          <h3 class="text-lg text-stone-900 mb-2 font-serif">No hay registros</h3>
          <p class="text-stone-600">No se encontraron mantenimientos con los filtros seleccionados</p>
        </div>
      }
    </div>
  </div>

  <!-- Modal: Agregar/Editar Mantenimiento -->
  @if (showAddMaintenanceModal) {
    <div class="fixed inset-0 bg-black/50 backdrop-blur-sm z-50 flex items-center justify-center p-4">
      <div class="bg-white rounded-2xl max-w-2xl w-full max-h-[90vh] overflow-y-auto">
        <div class="p-6 border-b border-stone-200">
          <div class="flex items-center justify-between">
            <h2 class="text-2xl font-serif text-stone-900">
              {{ editingMaintenance ? 'Editar' : 'Registrar' }} Mantenimiento
            </h2>
            <button
              (click)="closeModal()"
              class="p-2 hover:bg-stone-100 rounded-lg transition-colors"
            >
              <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <line x1="18" y1="6" x2="6" y2="18"/>
                <line x1="6" y1="6" x2="18" y2="18"/>
              </svg>
            </button>
          </div>
        </div>

        <div class="p-6 space-y-6">
          <!-- Vehículo -->
          <div>
            <label class="block text-sm font-medium text-stone-700 mb-2">Vehículo</label>
            <select
              [(ngModel)]="maintenanceForm.carId"
              class="w-full px-4 py-3 bg-white border border-stone-200 rounded-lg focus:ring-2 focus:ring-stone-400 focus:border-transparent"
            >
              <option value="">Selecciona un vehículo</option>
              @for (car of availableCars(); track car.id) {
                <option [value]="car.id">{{ car.brand }} {{ car.model }} ({{ car.year }})</option>
              }
            </select>
          </div>

          <!-- Tipo de Mantenimiento (múltiple) -->
          <div>
            <label class="block text-sm font-medium text-stone-700 mb-2">Tipo de Mantenimiento</label>
            <div class="grid grid-cols-2 gap-3">
              @for (type of maintenanceTypes; track type) {
                <label class="flex items-center space-x-2 p-3 border border-stone-200 rounded-lg cursor-pointer hover:bg-stone-50 transition-colors">
                  <input
                    type="checkbox"
                    [checked]="maintenanceForm.types.includes(type)"
                    (change)="toggleMaintenanceType(type)"
                    class="w-4 h-4 rounded border-stone-300 text-black focus:ring-stone-400"
                  />
                  <span class="text-sm text-stone-700">{{ type }}</span>
                </label>
              }
            </div>
          </div>

          <!-- Fecha de Inicio -->
          <div>
            <label class="block text-sm font-medium text-stone-700 mb-2">Fecha de Inicio</label>
            <input
              type="date"
              [(ngModel)]="maintenanceForm.startDate"
              class="w-full px-4 py-3 bg-white border border-stone-200 rounded-lg focus:ring-2 focus:ring-stone-400 focus:border-transparent"
            />
          </div>

          <!-- Mecánico -->
          <div>
            <label class="block text-sm font-medium text-stone-700 mb-2">Mecánico Asignado</label>
            <input
              type="text"
              [(ngModel)]="maintenanceForm.mechanic"
              placeholder="Nombre del mecánico"
              class="w-full px-4 py-3 bg-white border border-stone-200 rounded-lg focus:ring-2 focus:ring-stone-400 focus:border-transparent"
            />
          </div>

          <!-- Items de Gasto -->
          <div>
            <div class="flex items-center justify-between mb-3">
              <label class="block text-sm font-medium text-stone-700">Desglose de Gastos</label>
              <button
                type="button"
                (click)="addExpenseItem()"
                class="text-sm text-black hover:underline flex items-center space-x-1"
              >
                <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                  <line x1="12" y1="5" x2="12" y2="19"/>
                  <line x1="5" y1="12" x2="19" y2="12"/>
                </svg>
                <span>Agregar Item</span>
              </button>
            </div>

            <div class="space-y-3">
              @for (item of maintenanceForm.items; track $index; let i = $index) {
                <div class="p-4 bg-stone-50 rounded-lg border border-stone-200">
                  <div class="grid grid-cols-1 md:grid-cols-3 gap-3 mb-3">
                    <select
                      [(ngModel)]="item.category"
                      class="px-3 py-2 bg-white border border-stone-200 rounded-lg text-sm"
                    >
                      <option value="">Categoría</option>
                      <option value="Aceite">Aceite</option>
                      <option value="Filtros">Filtros</option>
                      <option value="Frenos">Frenos</option>
                      <option value="Llantas">Llantas</option>
                      <option value="Suspensión">Suspensión</option>
                      <option value="Batería">Batería</option>
                      <option value="Transmisión">Transmisión</option>
                      <option value="Motor">Motor</option>
                      <option value="Electricidad">Electricidad</option>
                      <option value="Carrocería">Carrocería</option>
                      <option value="Otro">Otro</option>
                    </select>

                    <input
                      type="number"
                      [(ngModel)]="item.cost"
                      placeholder="Costo"
                      class="px-3 py-2 bg-white border border-stone-200 rounded-lg text-sm"
                    />

                    <button
                      type="button"
                      (click)="removeExpenseItem(i)"
                      class="px-3 py-2 bg-red-100 hover:bg-red-200 text-red-700 rounded-lg text-sm transition-colors"
                    >
                      Eliminar
                    </button>
                  </div>

                  <input
                    type="text"
                    [(ngModel)]="item.description"
                    placeholder="Descripción (ej: Cambio de aceite sintético 5W-30)"
                    class="w-full px-3 py-2 bg-white border border-stone-200 rounded-lg text-sm"
                  />
                </div>
              }
            </div>
          </div>

          <!-- Notas -->
          <div>
            <label class="block text-sm font-medium text-stone-700 mb-2">Notas Adicionales</label>
            <textarea
              [(ngModel)]="maintenanceForm.notes"
              rows="3"
              placeholder="Observaciones, detalles adicionales..."
              class="w-full px-4 py-3 bg-white border border-stone-200 rounded-lg focus:ring-2 focus:ring-stone-400 focus:border-transparent resize-none"
            ></textarea>
          </div>

          <!-- Total Calculado -->
          <div class="p-4 bg-stone-100 rounded-lg border border-stone-200">
            <div class="flex items-center justify-between">
              <span class="text-sm font-medium text-stone-700">Total Calculado:</span>
              <span class="text-2xl font-serif text-stone-900">${{ calculateTotal() }}</span>
            </div>
          </div>
        </div>

        <div class="p-6 border-t border-stone-200 flex items-center justify-end space-x-3">
          <button
            (click)="closeModal()"
            class="px-6 py-3 bg-white hover:bg-stone-50 text-stone-900 rounded-lg font-medium border border-stone-200 transition-all"
          >
            Cancelar
          </button>
          <button
            (click)="saveMaintenance()"
            [disabled]="!isFormValid()"
            class="px-6 py-3 bg-black hover:bg-stone-800 text-white rounded-lg font-medium transition-all disabled:bg-stone-300 disabled:cursor-not-allowed"
          >
            {{ editingMaintenance ? 'Actualizar' : 'Registrar' }}
          </button>
        </div>
      </div>
    </div>
  }
</main>

<div class="w-screen relative left-1/2 right-1/2 -mx-[50vw]">
  <app-footer></app-footer>
</div>